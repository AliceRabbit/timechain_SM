# timechain_SM
国密版本的时间链
## 需求背景
作为新一代信息技术的重要组成部分，飞速发展的物联网（IoT）对设备本地时钟的准确性提出了更高的要求。普通的物联网设备拥有的计算资源、内存资源等极其有限，无法完成复杂的同步算法，如各种传感器和微型片上系统等。与此同时复杂的环境也对设备自身时钟的稳定性有着巨大的影响，如温度、湿度、网络攻击等，同时，物联网设备基数庞大并快速增长使得现有的时钟同步体系已经很难满足要求。一旦时钟同步出现问题，在生活方面会导致智能家居的行为出现混乱或影响车联网中的车辆安全等，在生产方面会产生工业生产中的工序错误从而造成停产等恶劣事故。因此如何保证物联网中设备的时钟同步安全问题已成为该领域不可忽视的重要问题。
## 部署方法
终端输入如下指令来部署系统（在Timechain.jar同目录下使用sudo权限执行）：

`java -jar timechain.jar`

或 `java -jar timechain.jar index, localHost, timeCenterIp, mainNode`

或 `java -jar timechain.jar httpPort, p2pPort, index, localHost, timeCenterIp, mainNode`

参数含义：

index:本节点编号

localHost：本节点ip

timeCenterIp：时间中心ip

mainNode：主节点ip

httpPort：监听的http端口，默认9000

p2pPort：p2p监听端口，默认6000

一般不建议修改端口，注意应在Linux防火墙中开放对应端口，以防无法节点间无法互相访问。

> 系统启动时，应先在主节点的服务器上启动时间链服务，主节点启动服务时localHsot以及mainPort均为自身ip地址。
## API
### 请求最新区块
>调用此接口会返回当前节点存储的区块链的最新区块数据，需要注意的是此区块一定是当前视图的最新区块，因为在共识的过程中节点不会将刚产生的区块发布给接口，只有当到达时间点te时才会发布出去，这样虽然外界不能及时获取最新产生的区块，但是能够保证整个链上的节点行为的一致性。

| 接口说明 | 请求最新的区块                                    |
| -------- | ------------------------------------------------- |
| 地址     | http://10.1.21.3:20000/api/v1/blocks/latest_block |
| 请求方式 | GET                                               |

返回结果采用JSON格式：

| JSON的key值  | 说明                 |
| ------------ | -------------------- |
| data         | 区块中存储的数据     |
| hash         | 本区块的hash         |
| index        | 区块的索引           |
| pk           | 打包区块的节点公钥   |
| previousHash | 上一个区块的hash     |
| signature    | 对区块链的签名       |
| timestamp    | 时间戳               |
| viewNumber   | 区块创建的视图索引值 |
### 获取节点列表
>调用此接口会返回当前节点能够连接到的所有节点，节点每个视图内都会更新自己能够连接到的节点列表，当新的节点接入到区块链网络中时，并不会立刻反映到此接口中，而是等到下一视图才会生效。这是考虑到节点刚加入网络时还没有与所有节点建立连接，因此可能造成不一致的问题。

| 接口说明 | 获取连接的节点                               |
| -------- | -------------------------------------------- |
| 地址     | http://10.1.21.3:20000/api/v1/peer/all_peers |
| 请求方式 | GET                                          |

返回JSON列表格式，每一项格式如下表：

| JSON的key值 | 说明                             |
| ----------- | -------------------------------- |
| pk          | 节点的数字签名，是节点的唯一标识 |
| IP          | 节点的IP值                       |

### 获取代理节点IP
>调用此接口会返回最新的在共识竞争中胜出的代表节点的IP值，这里之所以只给出IP值而没有节点的数字签名，是因为考虑到实际需求场景是其他设备想要同步当前时间信息，所以需要当前代表节点的IP来连接，而设备可能连接到的节点并不是代表节点，因此通过当前连接节点解析出代表节点位置。需要注明的是代理节点不一定是成功的代表节点，因为还要考虑到代表节点在共识成功后宕机的可能，因此当其不能代理时需启用备用节点来暂时代替代理节点。

| 接口说明 | 获取代理节点IP                              |
| -------- | ------------------------------------------- |
| 地址     | http://10.1.21.3:20000/api/v1/proxy_node_IP |
| 请求方式 | GET                                         |

返回的JSON数据格式如下：

| JSON的key值 | 说明       |
| ----------- | ---------- |
| IP          | 代理节点IP |
